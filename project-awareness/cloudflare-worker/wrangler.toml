name = "chittyops-project-awareness"
main = "src/worker.js"
compatibility_date = "2024-08-29"
compatibility_flags = ["nodejs_compat"]

# Custom domain configuration
routes = [
  { pattern = "project-awareness.chitty.cc/*", custom_domain = true }
]

# Environment variables
[vars]
ENVIRONMENT = "production"
CHITTY_REGISTRY_URL = "https://registry.chitty.cc"
CHITTYCHAT_API_URL = "https://chittychat.chitty.cc"
CHITTYID_API_URL = "https://chittyid.chitty.cc"
CORS_ORIGIN = "*"
SESSION_TIMEOUT = "3600"
MAX_SESSIONS_PER_IP = "10"
RATE_LIMIT_RPM = "1000"

# KV Namespaces for session and project state
[[kv_namespaces]]
binding = "SESSION_STORE"
id = "chittyops_sessions"
preview_id = "chittyops_sessions_preview"

[[kv_namespaces]]
binding = "PROJECT_STORE"
id = "chittyops_projects"
preview_id = "chittyops_projects_preview"

[[kv_namespaces]]
binding = "CROSS_PLATFORM_SYNC"
id = "chittyops_cross_platform"
preview_id = "chittyops_cross_platform_preview"

# Durable Objects for WebSocket connections and real-time sync
[[durable_objects.bindings]]
name = "PROJECT_AWARENESS_DO"
class_name = "ProjectAwarenessDurableObject"

[[durable_objects.bindings]]
name = "SESSION_SYNC_DO"
class_name = "SessionSyncDurableObject"

# R2 Storage for persistent project data and session history
[[r2_buckets]]
binding = "PROJECT_DATA_BUCKET"
bucket_name = "chittyops-project-data"
preview_bucket_name = "chittyops-project-data-preview"

# Analytics Engine for usage tracking
[[analytics_engine_datasets]]
binding = "USAGE_ANALYTICS"
dataset = "chittyops_usage"

# Secrets for authentication and API keys
# These should be set via: wrangler secret put SECRET_NAME
# Secrets:
# - CHITTYID_API_KEY: Authentication key for ChittyID services
# - CHITTYCHAT_API_KEY: Authentication key for ChittyChat integration
# - REGISTRY_API_KEY: Authentication key for ChittyRegistry
# - SESSION_ENCRYPTION_KEY: Key for encrypting session data
# - WEBHOOK_SECRET: Secret for validating webhooks
# - OPENAI_API_KEY: For OpenAI CustomGPT integration
# - JWT_SECRET: For JWT token signing

# Build configuration
[build]
command = "npm run build"

# Development configuration
[env.staging]
name = "chittyops-project-awareness-staging"
route = { pattern = "project-awareness-staging.chitty.cc/*", custom_domain = true }

[env.staging.vars]
ENVIRONMENT = "staging"
CORS_ORIGIN = "*"
RATE_LIMIT_RPM = "100"

[env.development]
name = "chittyops-project-awareness-dev"
vars.ENVIRONMENT = "development"
vars.CORS_ORIGIN = "*"

# Deployment configuration
[placement]
mode = "smart"

# Limits and performance
[limits]
cpu_ms = 50000